<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>EmotiBot - Chat</title>
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: linear-gradient(135deg, #74ebd5, #ACB6E5);
        overflow: hidden;
    }

    header {
        background: #4CAF50;
        color: white;
        padding: 15px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        position: relative;
        z-index: 10;
    }
    header h2 { margin:0; font-size:25px; flex:1; text-align:center; }
    .menu-btn { font-size:22px; background:none; border:none; color:white; cursor:pointer; }
    .logout {
        background-color: #c62828;
        color: white;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 5px;
        font-size: 14px;
        transition: 0.3s;
    }
    .logout:hover { background-color: #b71c1c; }

    .sidebar {
        height: 100%;
        width: 0;
        position: fixed;
        top: 0;
        left: 0;
        background-color: #11852e;
        overflow-x: hidden;
        transition: 0.3s;
        padding-top: 60px;
        display: flex;
        flex-direction: column;
        z-index: 1000;
        border-right: 2px solid #0a3f12;
    }
    .sidebar a {
        padding: 15px 25px;
        text-decoration: none;
        font-size: 18px;
        color: white;
        display: block;
        transition: 0.2s;
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .sidebar a:hover { background-color: #084b0f; }

    .chat-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        margin-left: 0;
        transition: margin-left 0.3s;
    }

    .mensaje {
        max-width: 70%;
        padding: 12px 18px;
        margin: 6px 0;
        border-radius: 20px;
        line-height: 1.5;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        word-wrap: break-word;
        font-size: 15px;
        transition: all 0.2s;
    }
    .usuario { background: #DCF8C6; align-self: flex-end; border-bottom-right-radius: 0; }
    .bot { background: #E5E5EA; align-self: flex-start; border-bottom-left-radius: 0; }

    form {
        display: flex;
        padding: 15px;
        background: #fff;
        border-top: 1px solid #ccc;
    }
    input[type="text"] {
        flex: 1;
        padding: 12px 15px;
        border: 1px solid #ccc;
        border-radius: 25px;
        outline: none;
        font-size: 15px;
        transition: all 0.2s;
    }
    input[type="text"]:focus {
        border-color: #4CAF50;
        box-shadow: 0 0 8px rgba(76,175,80,0.3);
    }
    button { background: #4CAF50; border:none; color:white; padding:12px 20px; margin-left:10px; border-radius:25px; cursor:pointer; font-weight:bold; transition: all 0.3s; }
    button:hover { background:#45a049; }

    .chat-container::-webkit-scrollbar { width: 8px; }
    .chat-container::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
    .chat-container::-webkit-scrollbar-track { background: transparent; }
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar" class="sidebar">
  <a href="directorio.html">ðŸ“– Directorio</a>
</div>

<!-- Header -->
<header>
  <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
  <h2>ðŸ‘‹ Hola</h2>
  <a href="#" class="logout" onclick="logout()">ðŸšª Cerrar sesiÃ³n</a>
</header>

<!-- Chat -->
<div id="chat" class="chat-container"></div>

<!-- Formulario -->
<form id="chatForm">
  <input type="text" id="mensajeInput" placeholder="Escribe tu mensaje aquÃ­..." required autofocus>
  <button type="submit">Enviar</button>
</form>

<script type="module">
  import { auth, db } from './firebase-config.js';
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
  import { collection, addDoc, serverTimestamp, query, where, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

  const chatContainer = document.getElementById("chat");
  const chatForm = document.getElementById("chatForm");
  const mensajeInput = document.getElementById("mensajeInput");

  function toggleSidebar() {
    let sidebar = document.getElementById("sidebar");
    if(sidebar.style.width === "250px") { sidebar.style.width="0"; chatContainer.style.marginLeft="0"; }
    else { sidebar.style.width="250px"; chatContainer.style.marginLeft="250px"; }
  }

  function logout() {
    signOut(auth).then(() => window.location.href = "login.html");
  }

  // AutenticaciÃ³n y mensajes en tiempo real
  onAuthStateChanged(auth, (user) => {
    if(!user) { window.location.href="login.html"; return; }
    document.querySelector('header h2').textContent = `ðŸ‘‹ Hola ${user.displayName || user.email}, bienvenido a EmotiBot`;

    const q = query(
      collection(db, "conversaciones"),
      where("usuarioId", "==", user.uid),
      orderBy("timestamp")
    );

    onSnapshot(q, (snapshot) => {
      chatContainer.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "mensaje " + (data.remitente==="TÃº" ? "usuario" : "bot");
        div.innerHTML = `<strong>${data.remitente}:</strong> ${data.texto}`;
        chatContainer.appendChild(div);
      });
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });
  });

  // Enviar mensaje
  chatForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if(!user) return;

    const texto = mensajeInput.value;
    mensajeInput.value = "";

    await addDoc(collection(db, "conversaciones"), {
      usuarioId: user.uid,
      remitente: "TÃº",
      texto: texto,
      timestamp: serverTimestamp()
    });

    // AquÃ­ podrÃ­as llamar a tu backend o funciÃ³n que genere la respuesta del bot
    // y guardarla tambiÃ©n en Firestore como remitente "Bot"
  });

</script>
</body>
</html>
